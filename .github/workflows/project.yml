run-name: Project automate

on:
  issues:
    types:
      ["opened", "reopened", "labeled", "unlabeled", "assigned", "unassigned"]

  pull_request:
    types: ["opened", "reopened", "labeled", "unlabeled"]

jobs:
  fetch-details:
    runs-on: ubuntu-latest
    outputs: 
      ids: ${{ steps.get-required-ids.outputs.ids }}
      PRJ: ${{ steps.fetch-prj-details.outputs.PRJ }}
    steps:
      - name: Get reuired IDs
        id: get-required-ids
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            // Fetch data for github project
            const resp = await github.graphql(`query getOrgProjRepoId {
              repository(owner:"${{ github.repository_owner }}", name:"${{ github.event.repository.name }}") {
                id
              },
              organization(login:"${{ github.repository_owner }}") {
                id
                projectsV2(first: 10) {
                  nodes {
                    number,
                    title,
                    id
                  }
                }
              }
            }`)
            
            // Find project number and id from project name
            const prj = resp.organization.projectsV2.nodes.filter((node) => node.title == "${{ vars.MAIN_PRJ }}")
            if( prj.length == 0 ) {
              console.log("No projects found with name: ${{ vars.MAIN_PRJ }}")
              return false
            } 
            
            const IDs = {
              'REPO_ID': resp.repository.id,
              'PRJ_ID': prj[0].id,
              'PRJ_NUM': prj[0].number,
              'ORG_ID': resp.organization.id,
            }
            core.setOutput('REPO_ID', resp.repository.id)
            core.setOutput('PRJ_ID', prj[0].id)
            core.setOutput('PRJ_NUM', prj[0].number)
            core.setOutput('ORG_ID', resp.organization.id)
            core.setOutput('ids', JSON.stringify(IDs))
      
      - name: Fetch project details
        id: fetch-prj-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const getPrjFields = await github.graphql(`query getPrjFields {
              node(id:"${{ steps.get-required-ids.outputs.PRJ_ID }}") {
                ... on ProjectV2 {
                  id
                  fields(first: 20) {
                    totalCount
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                      ... on ProjectV2IterationField {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }`)
            console.log(JSON.stringify(getPrjFields))
            core.setOutput('PRJ', JSON.stringify(getPrjFields.node))

      - name: Print outputs
        id: print-outputs
        uses: actions/github-script@v7
        with:
          script: |
            console.log("Steps: ")
            console.log(${{ toJSON(steps) }})
            console.log("Job: ")
            console.log(${{ toJSON(job) }})

  issue-automation:
    name: Issue automation- ${{ github.event.issue.number }}
    needs: fetch-details
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest

    steps:
      - name: Get Issue details
        id: issue-details
        uses: actions/github-script@v7
        with: 
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            // Fetch data for github project
            const vars = ${{ needs.fetch-details.outputs.ids }}
            const resp = await github.graphql(`query getIssueId($REPO_ID: ID!) {
              node(id:$REPO_ID) {
                ... on Repository {
                  id
                  issue(number: ${{ github.event.issue.number }}) {
                    id
                    projectItems(first: 10) {
                      totalCount
                    }
                  }
                }
              }
            }`, vars)
            core.setOutput('ISSUE_ID', resp.node.issue.id)
            core.setOutput('PRJ_CNT', resp.node.issue.projectItems.totalCount)
            console.log(resp.node.issue.projectItems.totalCount)
            
      - name: Opened/ Reopned
        id: opened-reopned
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const totalCount = ${{ steps.issue-details.outputs.PRJ_CNT }}
            const vars = ${{ needs.fetch-details.outputs.ids }}

            if( totalCount == 0 ) {
              //Add issue to project
              const AddIssueToProjectResp = await github.graphql(`mutation AddIssueToProject($ORG_ID: String!, $PRJ_ID: ID!) {
                addProjectV2ItemById( input: {
                  clientMutationId:$ORG_ID
                  contentId:"${{ steps.issue-details.outputs.ISSUE_ID }}"
                  projectId:$PRJ_ID
                  }) {
                  clientMutationId
                  item {
                    id
                  }
                }
              }`, vars)

              if( AddIssueToProjectResp.addProjectV2ItemById.clientMutationId == vars.ORG_ID ) {
                console.log("Issue got added to project: ${{ vars.MAIN_PRJ }}")
                return true
              }
              else {
                console.log("Error while adding Issue: ${{ github.event.issue.number }} to project: ${{ vars.MAIN_PRJ }}")
                return false
              }
            }
            console.log("Issue already associate with github project.");
            return false

      - name: Get ITEM ID
        id: get-item-id
        if: github.event.action != 'opened' || github.event.action != 'reopened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const totalCount = ${{ steps.issue-details.outputs.PRJ_CNT }}
            if( totalCount == 0 ) {
              console.log("Issue not associate with any github project.");
              return false
            }
            const vars = ${{ needs.fetch-details.outputs.ids }}
            var isFound = false
            var isOver = false
            vars.cursor = ""
            var itemNodes = []

            while(isFound == false && isOver == false) {
              const getItemIdResp = await github.graphql(`query getItemID($PRJ_ID: ID!, $cursor: String!) {
                node(id:$PRJ_ID) {
                  ... on ProjectV2 {
                    id
                    items(first: 10, after:$cursor, orderBy: {
                      field:POSITION,
                      direction:DESC
                    }) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            title
                          }
                        }
                      }
                      pageInfo {
                        endCursor
                        hasNextPage
                      }
                    }
                  }
                }
              }`, vars)
              console.log(isFound)
              console.log(isOver)
              itemNodes = getItemIdResp.node.items.nodes.filter((node) => node.content.__typename == 'Issue' && node.content.number == ${{ github.event.issue.number }})
              console.log(JSON.stringify(getItemIdResp.node.items))
              console.log("ITEM NODE --------------------------------")
              console.log(JSON.stringify(itemNodes))
              if( itemNodes.length > 0 ) {
                isFound = true
                break
              }
              if( getItemIdResp.node.items.pageInfo.hasNextPage ) {
                vars.cursor = getItemIdResp.node.items.pageInfo.endCursor
              }
              else {
                isOver = true
                break;
              }
            }
            console.log(JSON.stringify(itemNodes))
            console.log(isFound)
            console.log(isOver)
            console.log(typeof isFound)
            console.log(typeof isOver)
            console.log(isFound == true)
            console.log(typeof true)
            if( isFound == true) {
              core.setOutput('ITEM_ID', itemNodes[0].id)
              return true
            }
            console.log("Issue: ${{ github.event.issue.number }} is not associated with GitHub project: ${{ vars.MAIN_PRJ }}")
            return false

      - name: Labeled
        id: labeled
        if: github.event.action == 'labeled'
        uses: actions/github-script@v7
        with: 
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const totalCount = ${{ steps.issue-details.outputs.PRJ_CNT }}
            const vars = ${{ needs.fetch-details.outputs.ids }}
            
            if( totalCount == 0 ) {
              console.log("Issue not associate with any github project.");
              return false
            }

            const prj = ${{ needs.fetch-details.outputs.PRJ }}
            const fieldNode = prj.fields.nodes.filter((node) => node.name.toUpperCase() == 'status'.toUpperCase())
            vars["FIELD_ID"] = fieldNode[0].id

            if( "${{ github.event.label.name }}" == 'epic') {
              vars["OPTION_ID"] = fieldNode[0].options.filter((option) => option.name == ":file_cabinet: Epic")[0].id
            }
            else if( "${{ github.event.label.name }}" == 'accepted' ) {
              vars["OPTION_ID"] = fieldNode[0].options.filter((option) => option.name == "ðŸ“‹ Product Backlog")[0].id
            }
            else {
              return
            }
            const UpdateIssueStatusResp = await github.graphql(`mutation UpdateIssueStatus($ORG_ID: String!, $PRJ_ID: ID!, $FIELD_ID: ID!, $OPTION_ID: String!) {
              updateProjectV2ItemFieldValue( input: {
                clientMutationId:$ORG_ID
                projectId:$PRJ_ID
                itemId:"${{ steps.get-item-id.outputs.ITEM_ID }}"
                fieldId:$FIELD_ID
                value: {
                  singleSelectOptionId: $OPTION_ID
                }
              }) {
                clientMutationId
                projectV2Item {
                  id
                }
              }
            }`, vars)

            if( AddIssueToProjectResp.addProjectV2ItemById.clientMutationId == vars.ORG_ID ) {
              console.log("Issue Status changes to: " + fieldNode[0].name)
              return true
            }
            else {
              console.log("Error while changing Issue: ${{ github.event.issue.number }} status to: " + fieldNode[0].name)
              return false
            }
          
      - name: Unlabeled
        id: unlabeled
        if: ${{ github.event.action }} == 'unlabeled'
        uses: actions/github-script@v7
        with: 
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const totalCount = ${{ steps.issue-details.outputs.PRJ_CNT }}
            const vars = ${{ needs.fetch-details.outputs.ids }}
            
            if( totalCount == 0 ) {
              console.log("Issue not associate with any github project.");
              return false
            }
            const prj = ${{ needs.fetch-details.outputs.PRJ }}
            const fieldNode = prj.fields.nodes.filter((node) => node.name.toUpperCase() == 'status'.toUpperCase())
            vars["FIELD_ID"] = fieldNode[0].id
            if( "${{ github.event.label.name }}" == 'epic') {
              vars["OPTION_ID"] = fieldNode[0].options.filter((option) => option.name == "ðŸ“‹ Product Backlog")[0].id
            }
            else if( "${{ github.event.label.name }}" == 'accepted' ) {
              vars["OPTION_ID"] = fieldNode[0].options.filter((option) => option.name == "ðŸ†• New")[0].id
            }
            else {
              return
            }
            const UpdateIssueStatusResp = await github.graphql(`mutation UpdateIssueStatus($ORG_ID: String!, $PRJ_ID: ID!, $FIELD_ID: ID!, $OPTION_ID: String!) {
              updateProjectV2ItemFieldValue( input: {
                clientMutationId:$ORG_ID
                projectId:$PRJ_ID
                itemId:"${{ steps.get-item-id.outputs.ITEM_ID }}"
                fieldId:$FIELD_ID
                value: {
                  singleSelectOptionId: $OPTION_ID
                }
              }) {
                clientMutationId
                projectV2Item {
                  id
                }
              }
            }`, vars)

            if( AddIssueToProjectResp.addProjectV2ItemById.clientMutationId == vars.ORG_ID ) {
              console.log("Issue Status changes to: " + fieldNode[0].name)
              return true
            }
            else {
              console.log("Error while changing Issue: ${{ github.event.issue.number }} Status to: " + fieldNode[0].name)
              return false
            }
          
      - name: Assigned
        id: assigned
        if: ${{ github.event.action }} == 'assigned'
        uses: actions/github-script@v7
        with:
          script: |
            // Check assigned event
            if( ${{ steps.issue-details.outputs.PRJ_CNT }} == 0 ) {
              console.log("Issue is not added to any github projects.");
              console.log("Unable to move issue to 'In progress' column");
              return false
            }

      - name: Unassigned
        id: unassigned
        if: ${{ github.event.action }} == 'unassigned'
        uses: actions/github-script@v7
        with: 
          script: |

      - name: Print context 1
        if: always()
        uses: actions/github-script@v7
        with:
          script: console.log(${{ toJson(steps) }})

      - name: Print context 2
        if: always()
        uses: actions/github-script@v7
        with:
          script: console.log(${{ toJson(github) }})

  pr-automation:
    needs: fetch-details
    runs-on: ubuntu-latest

    steps:
      - run: echo "Pull request automation"
#      - name: Checkout repository
#      - name: Get required ids
#      - name: Handle new Pull Request
#      - name: Labeled Pull Request - ${{ github.event.issue.numer }}
#      - name: Unlabeled Pull Request - ${{ github.event.issue.numer }}
#      - name: Assigned Pull Request - ${{ github.event.issue.number }}
#      - name: Unassigned Pull Request - ${{ github.event.issue.number }}
