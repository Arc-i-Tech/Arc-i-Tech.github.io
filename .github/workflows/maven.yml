run-name: Maven build by event :'${{ github.event_name }}' on branch :'${{ github.ref_name }}' by user :'${{ github.actor }}'
on:
  repository_dispatch: # To support manual trigger.
  push:
    branches: [development, '*-E-*']
  pull_request: 
    branches: [development, '*-E-*'] 
    types: [opened, synchronize]

jobs:
  maven-build-pkg-creation:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout repository
        id: checkout-repo
        uses: actions/checkout@v4
        env:
          github_token: ${{ secrets.ACCESS_TOKEN }}

      - name: Setup Java 
        id: setup-java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 8.0.392+8     
        
      - name: Run maven
        id: run-mvn-pkg
        run: mvn package
        
      - name: Commit binary artifact
        id: commit-binary-artifact
        if: github.event_name == 'push'
        uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actor
          message: Mevan package from github [action:${{ github.run_number }}](https://github.com/Arc-i-Tech/Arc-i-Tech.github.io/actions/runs/${{ github.run_id }}) triggred by @${{ github.actor }}
        
      - name: Create pull request to test branch
        id: create-pr-to-test
        if: github.event_name == 'push' && github.ref_name == 'development'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: github.ref_name,
              base: 'test',
              title: "Push Test",
              body: "PR created as there is push on branch :**development**"
            })

      - name: Add Comment to pull request :${{ github.event.number }}
        id: add-comment-to-pr
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "The job: **${{ github.job }}** is executed successfully!"
            }) |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['success']
            })

      - name: Find failed step
        id: handle-failure
        if: failure()
        uses: dkershner6/switch-case-action@v1
        with:
          default: "NaN"
          conditionals-with-values: |
            ${{ steps.checkout-repo.outcome != 'success' && steps.checkout-repo.outcome != 'skipped' }} => checkout-repo
            ${{ steps.setup-java.outcome != 'success'  && steps.setup-java.outcome != 'skipped' }} => setup-java
            ${{ steps.run-mvn-pkg.outcome != 'success' && steps.run-mvn-pkg.outcome != 'skipped' }} => run-mvn-pkg
            ${{ steps.commit-binary-artifact.outcome != 'success' && steps.commit-binary-artifact.outcome != 'skipped' }} => commit-binary-artifact
            ${{ steps.create-pr-to-test.outcome != 'success' && steps.create-pr-to-test.outcome != 'skipped' }} => create-pr-to-test
            ${{ steps.add-comment-to-pr.outcome != 'success' && steps.add-comment-to-pr.outcome != 'skipped' }} => add-comment-to-pr

      - name: Pull request - failed on base branch :${{ github.base_ref }}
        id: handle-failure-pr
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "The job: **${{ github.job }}** has failed at step: **${{ steps.handle-failure.outputs.value }}** [Action url](https://github.com/Arc-i-Tech/Arc-i-Tech.github.io/actions/runs/${{ github.run_id }})"
            }) |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['failed']
            })
      
      - name: Push - failed on branch :${{ github.ref_name }}
        id: handle-failure-push
        if: failure() && github.event_name == 'push' && github.ref_name == 'development'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "The job: **${{ github.job }}** is **failed** on push to branch: **${{ github.ref_name }}**",
              body: "",
              assignee: "",
              labels: ["failed", "urgent"]
            })

      - name: Push - failed on branch :${{ github.ref_name }}
        id: find-epic-issue-number
        if: failure() && github.event_name == 'push' && contains(github.ref_name, '-E-')
        run: NUMBER=$(echo "93-E-github-action-workflows" | tr -dc '0-9'); 
          echo "EPIC_NUMBER=$NUMBER" >> $GITHUB_OUTPUT
        shell: shell

      - name: Push - failed on branch :${{ github.ref_name }}
        id: print-issue-number
        if: failure() && github.event_name == 'push' && contains(github.ref_name, '-E-')
        run: echo "Output [${{steps.find-epic-issue-number.outputs.EPIC_NUMBER}}]"
        shell: shell

      - name: Success message
        id: success-message
        if: success()
        run: echo ${{ github.job }} completed successfully.
